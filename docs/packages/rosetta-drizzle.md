# @sylphx/rosetta-drizzle

Drizzle ORM storage adapter supporting PostgreSQL, SQLite, and MySQL.

## Installation

```bash
bun add @sylphx/rosetta-drizzle
```

## Entry Points

| Entry | Description |
|-------|-------------|
| `@sylphx/rosetta-drizzle` | Adapter and schema exports |
| `@sylphx/rosetta-drizzle/schema` | Schema-only exports |

## Quick Setup

### 1. Add Schema

::: code-group

```ts [PostgreSQL]
// db/schema.ts
import { createRosettaSchema } from '@sylphx/rosetta-drizzle';

export const { rosettaSources, rosettaTranslations } = createRosettaSchema();

// Your other tables...
export const users = pgTable('users', { /* ... */ });
```

```ts [SQLite]
// db/schema.ts
import { createRosettaSchemaSQLite } from '@sylphx/rosetta-drizzle';

export const { rosettaSources, rosettaTranslations } = createRosettaSchemaSQLite();
```

```ts [MySQL]
// db/schema.ts
import { createRosettaSchemaMySQL } from '@sylphx/rosetta-drizzle';

export const { rosettaSources, rosettaTranslations } = createRosettaSchemaMySQL();
```

:::

### 2. Run Migration

```bash
bun drizzle-kit push
# or
bun drizzle-kit generate
bun drizzle-kit migrate
```

### 3. Create Adapter

```ts
// lib/rosetta/storage.ts
import { DrizzleStorageAdapter } from '@sylphx/rosetta-drizzle';
import { db } from '@/db';
import { rosettaSources, rosettaTranslations } from '@/db/schema';

export const storage = new DrizzleStorageAdapter({
  db,
  sources: rosettaSources,
  translations: rosettaTranslations,
});
```

## Schema Details

### Sources Table

Stores source strings extracted from code:

```sql
CREATE TABLE rosetta_sources (
  id SERIAL PRIMARY KEY,
  hash VARCHAR(8) UNIQUE NOT NULL,    -- DJB2 hash
  text TEXT NOT NULL,                  -- Original text
  context VARCHAR(255),                -- Optional context
  occurrences INT DEFAULT 1,           -- Times seen in code
  first_seen_at TIMESTAMP DEFAULT NOW(),
  last_seen_at TIMESTAMP DEFAULT NOW()
);
```

### Translations Table

Stores translations per locale:

```sql
CREATE TABLE rosetta_translations (
  id SERIAL PRIMARY KEY,
  locale VARCHAR(10) NOT NULL,         -- e.g., 'en', 'zh-TW'
  hash VARCHAR(8) NOT NULL,            -- References source hash
  text TEXT NOT NULL,                  -- Translated text
  source_hash VARCHAR(8),              -- Hash of source at translation time
  auto_generated BOOLEAN DEFAULT FALSE, -- AI-generated flag
  reviewed BOOLEAN DEFAULT FALSE,       -- Human-reviewed flag
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(locale, hash)                 -- One translation per locale+hash
);
```

## Custom Table Names

```ts
const { rosettaSources, rosettaTranslations } = createRosettaSchema({
  sourcesTable: 'i18n_sources',
  translationsTable: 'i18n_translations',
});
```

## Pre-Built Schemas

For direct use without customization:

```ts
// PostgreSQL
import {
  pgRosettaSources,
  pgRosettaTranslations,
  pgRosettaSchema,
} from '@sylphx/rosetta-drizzle';

// SQLite
import {
  sqliteRosettaSources,
  sqliteRosettaTranslations,
  sqliteRosettaSchema,
} from '@sylphx/rosetta-drizzle';

// MySQL
import {
  mysqlRosettaSources,
  mysqlRosettaTranslations,
  mysqlRosettaSchema,
} from '@sylphx/rosetta-drizzle';
```

## Adapter Configuration

```ts
const storage = new DrizzleStorageAdapter({
  db,                      // Drizzle database instance
  sources: rosettaSources,  // Sources table
  translations: rosettaTranslations, // Translations table
});
```

## Adapter Methods

### Required Methods

```ts
// Get all translations for a locale
const translations = await storage.getTranslations('zh-TW');
// Returns: Map<hash, text>

// Save a single translation
await storage.saveTranslation('zh-TW', 'abc123', '你好', {
  autoGenerated: true,
  sourceHash: 'def456',
});

// Get all source strings
const sources = await storage.getSources();
// Returns: [{ hash, text, context }, ...]

// Get untranslated strings for a locale
const untranslated = await storage.getUntranslated('zh-TW');
// Returns: [{ hash, text, context }, ...]

// Get available locales
const locales = await storage.getAvailableLocales();
// Returns: ['en', 'zh-TW', 'ja']
```

### Admin Methods

```ts
// Get sources with all translations (for admin UI)
const data = await storage.getSourcesWithTranslations(['en', 'zh-TW']);
// Returns: [{
//   hash, text, context,
//   translations: {
//     'en': { text, autoGenerated, reviewed, sourceHash },
//     'zh-TW': { text, autoGenerated, reviewed, sourceHash },
//   }
// }, ...]

// Mark translation as reviewed
await storage.markAsReviewed('zh-TW', 'abc123');

// Batch save translations
await storage.saveTranslations('zh-TW', new Map([
  ['abc123', '你好'],
  ['def456', '世界'],
]));
```

## Database-Specific Notes

### PostgreSQL

- Uses `SERIAL` for auto-increment
- Timestamp with timezone
- Best for production

### SQLite

- Uses `INTEGER PRIMARY KEY AUTOINCREMENT`
- Timestamp stored as INTEGER (Unix epoch)
- Good for development/edge (Turso, D1)

### MySQL

- Uses `INT AUTO_INCREMENT`
- `VARCHAR` with explicit lengths
- `BOOLEAN` is `TINYINT(1)`

## Edge Runtime Databases

### Neon (PostgreSQL)

```ts
import { drizzle } from 'drizzle-orm/neon-http';
import { neon } from '@neondatabase/serverless';

const sql = neon(process.env.DATABASE_URL!);
const db = drizzle(sql);

const storage = new DrizzleStorageAdapter({
  db,
  sources: rosettaSources,
  translations: rosettaTranslations,
});
```

### Turso (SQLite)

```ts
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

const client = createClient({
  url: process.env.TURSO_DATABASE_URL!,
  authToken: process.env.TURSO_AUTH_TOKEN!,
});
const db = drizzle(client);

const storage = new DrizzleStorageAdapter({
  db,
  sources: sqliteRosettaSources,
  translations: sqliteRosettaTranslations,
});
```

### PlanetScale (MySQL)

```ts
import { drizzle } from 'drizzle-orm/planetscale-serverless';
import { connect } from '@planetscale/database';

const connection = connect({
  url: process.env.DATABASE_URL!,
});
const db = drizzle(connection);

const storage = new DrizzleStorageAdapter({
  db,
  sources: mysqlRosettaSources,
  translations: mysqlRosettaTranslations,
});
```

## Types

### DrizzleStorageAdapterConfig

```ts
interface DrizzleStorageAdapterConfig {
  db: DrizzleQueryBuilder;
  sources: SourcesTable;
  translations: TranslationsTable;
}
```

### SourcesTable / TranslationsTable

Type aliases for the Drizzle table types.

## Migration Example

### Initial Migration

```sql
-- 0001_create_rosetta_tables.sql

CREATE TABLE rosetta_sources (
  id SERIAL PRIMARY KEY,
  hash VARCHAR(8) UNIQUE NOT NULL,
  text TEXT NOT NULL,
  context VARCHAR(255),
  occurrences INT DEFAULT 1 NOT NULL,
  first_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  last_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE TABLE rosetta_translations (
  id SERIAL PRIMARY KEY,
  locale VARCHAR(10) NOT NULL,
  hash VARCHAR(8) NOT NULL,
  text TEXT NOT NULL,
  source_hash VARCHAR(8),
  auto_generated BOOLEAN DEFAULT FALSE NOT NULL,
  reviewed BOOLEAN DEFAULT FALSE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  UNIQUE(locale, hash)
);

CREATE INDEX idx_translations_locale ON rosetta_translations(locale);
CREATE INDEX idx_translations_hash ON rosetta_translations(hash);
```

## Next Steps

- [Quick Start](/guide/quick-start) - Full setup guide
- [Storage Adapter](/advanced/storage-adapter) - Custom implementations
- [Admin Dashboard](/packages/rosetta-admin) - Translation management
