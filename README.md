# @sylphx/lingua

Lightweight i18n library with **production-time string collection** and **LLM-powered translation**.

## Features

- **Zero config source strings** - Write English directly in code: `t("Hello World")`
- **Auto-collection** - Strings collected in production as users hit code paths
- **LLM translation** - Generate translations using OpenRouter, Anthropic, etc.
- **Server + Client** - Full Next.js App Router support with RSC
- **Type-safe** - Full TypeScript support
- **Adapter pattern** - Bring your own storage (Drizzle, Prisma, etc.)

## Installation

```bash
bun add @sylphx/lingua
```

## Quick Start

### 1. Create Storage Adapter

```typescript
// lib/i18n/storage.ts
import type { StorageAdapter } from '@sylphx/lingua';
import { db } from '@/db';
import { translations, translationSources } from '@/db/schema';

export const storage: StorageAdapter = {
  async getTranslations(locale) {
    const rows = await db
      .select()
      .from(translations)
      .where(eq(translations.locale, locale));

    return new Map(rows.map(r => [r.sourceHash, r.translatedText]));
  },

  async registerSources(sources) {
    await db
      .insert(translationSources)
      .values(sources.map(s => ({
        sourceText: s.text,
        sourceHash: s.hash,
        context: s.context,
      })))
      .onConflictDoNothing();
  },

  async saveTranslation(locale, hash, text, options) {
    await db
      .insert(translations)
      .values({
        locale,
        sourceHash: hash,
        translatedText: text,
        sourceText: options?.sourceText,
        autoGenerated: options?.autoGenerated ?? false,
      })
      .onConflictDoUpdate({
        target: [translations.locale, translations.sourceHash],
        set: { translatedText: text },
      });
  },

  async getSources() {
    return db.select().from(translationSources);
  },

  async getUntranslated(locale) {
    // Return sources that don't have translations for this locale
    const translated = await db
      .select({ hash: translations.sourceHash })
      .from(translations)
      .where(eq(translations.locale, locale));

    const translatedHashes = new Set(translated.map(t => t.hash));
    const sources = await db.select().from(translationSources);

    return sources.filter(s => !translatedHashes.has(s.sourceHash));
  },
};
```

### 2. Initialize I18n

```typescript
// lib/i18n/index.ts
import { I18n } from '@sylphx/lingua/server';
import { OpenRouterAdapter } from '@sylphx/lingua/adapters';
import { cookies } from 'next/headers';
import { storage } from './storage';

export const i18n = new I18n({
  storage,
  translator: new OpenRouterAdapter({
    apiKey: process.env.OPENROUTER_API_KEY!,
  }),
  defaultLocale: 'en',
  enabledLocales: ['en', 'zh-TW', 'zh-CN'],
  localeDetector: async () => {
    const cookieStore = await cookies();
    return cookieStore.get('locale')?.value ?? 'en';
  },
});

export { t, flushCollectedStrings, getTranslationsForClient, getLocale } from '@sylphx/lingua/server';
```

### 3. Set Up Layout

```tsx
// app/layout.tsx
import { i18n, flushCollectedStrings, getTranslationsForClient, getLocale } from '@/lib/i18n';
import { I18nProvider } from '@sylphx/lingua/client';

export default async function RootLayout({ children }: { children: React.ReactNode }) {
  return i18n.init(async () => {
    const content = (
      <html lang={getLocale()}>
        <body>
          <I18nProvider
            locale={getLocale()}
            translations={getTranslationsForClient()}
          >
            {children}
          </I18nProvider>
        </body>
      </html>
    );

    // Flush collected strings at end of request
    await flushCollectedStrings();
    return content;
  });
}
```

### 4. Use Translations

**Server Components:**
```tsx
import { t } from '@/lib/i18n';

export function ServerComponent() {
  return (
    <div>
      <h1>{t("Welcome to our app")}</h1>
      <p>{t("Hello {name}", { name: "World" })}</p>
    </div>
  );
}
```

**Client Components:**
```tsx
'use client';
import { useT } from '@sylphx/lingua/client';

export function ClientComponent() {
  const t = useT();

  return (
    <button>{t("Sign In")}</button>
  );
}
```

## How It Works

```
┌─────────────────────────────────────────────────────────────────┐
│  PRODUCTION                                                      │
│  Real users → t("Hello") → 1. Return translation                │
│                           → 2. Queue for collection (async)     │
│                                                                  │
│  End of request → flushCollectedStrings() → Save to DB          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  ADMIN DASHBOARD                                                 │
│  • View all collected strings                                    │
│  • LLM auto-translate (one-click)                               │
│  • Manual translation / review                                   │
│  • Export → External tools → Import                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  PRODUCTION (after translations saved)                          │
│  Users → t("Hello") → DB lookup → Return "你好"                 │
└─────────────────────────────────────────────────────────────────┘
```

## API Reference

### Server (`@sylphx/lingua/server`)

#### `I18n` class

```typescript
const i18n = new I18n({
  storage: StorageAdapter,      // Required: your storage adapter
  translator?: TranslateAdapter, // Optional: for auto-translation
  defaultLocale?: string,        // Default: 'en'
  enabledLocales?: string[],     // Default: ['en', 'zh-TW', 'zh-CN']
  cacheTTL?: number,             // Default: 60000 (1 minute)
  localeDetector?: () => string, // Function to detect current locale
});

// Methods
await i18n.init(fn)              // Initialize context and run function
await i18n.getClientData()       // Get data for client hydration
await i18n.getSources()          // Get all source strings
await i18n.getUntranslated(locale) // Get untranslated strings
await i18n.getStats()            // Get translation statistics
await i18n.generateAndSave(text, locale) // Auto-translate and save
await i18n.saveTranslation(locale, text, translation) // Manual save
i18n.invalidateCache()           // Clear translation cache
```

#### `t(text, params?)` function

```typescript
t("Hello World")                  // Simple translation
t("Hello {name}", { name: "John" }) // With interpolation
t("Submit", { context: "form" })  // With context for disambiguation
```

#### Other exports

```typescript
flushCollectedStrings()   // Flush pending strings to storage
getLocale()               // Get current locale
getTranslationsForClient() // Get translations for client provider
```

### Client (`@sylphx/lingua/client`)

```tsx
<I18nProvider locale="en" translations={translations}>
  {children}
</I18nProvider>

const t = useT();           // Get translation function
const locale = useLocale(); // Get current locale
```

### Adapters (`@sylphx/lingua/adapters`)

```typescript
import { OpenRouterAdapter } from '@sylphx/lingua/adapters';

const translator = new OpenRouterAdapter({
  apiKey: string,           // Required
  model?: string,           // Default: 'openai/gpt-4.1-mini'
  temperature?: number,     // Default: 0.3
  maxTokens?: number,       // Default: 500
});
```

## Database Schema Example (Drizzle)

```typescript
// db/schema.ts
import { pgTable, text, timestamp, boolean, serial } from 'drizzle-orm/pg-core';

export const translationSources = pgTable('translation_sources', {
  id: serial('id').primaryKey(),
  sourceText: text('source_text').notNull(),
  sourceHash: text('source_hash').notNull().unique(),
  context: text('context'),
  createdAt: timestamp('created_at').defaultNow(),
});

export const translations = pgTable('translations', {
  id: serial('id').primaryKey(),
  sourceHash: text('source_hash').notNull(),
  sourceText: text('source_text').notNull(),
  locale: text('locale').notNull(),
  translatedText: text('translated_text'),
  autoGenerated: boolean('auto_generated').default(false),
  reviewed: boolean('reviewed').default(false),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});
```

## License

MIT
